<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Therapist Dashboard — Moner Kotha</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --mk-primary: #2F4156;
      --mk-accent: #C8D9E6;
      --mk-pink: #F7CBCA;
    }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    /* minor scroll styling */
    .scrollbar-thin::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(47,65,86,0.12); border-radius: 8px; }
  </style>
</head>
<body class="bg-[#F7F5F2] text-[var(--mk-primary)] min-h-screen">

  <div class="flex h-screen">

    <!-- Sidebar -->
    <aside class="w-72 bg-white border-r border-[var(--mk-accent)] flex flex-col">
      <div class="p-6">
        <img src="images/Moner Kotha - Logo.png" alt="logo" class="w-40 mb-4 object-contain"/>
        <div class="flex items-center gap-3">
          <img id="therapistAvatar" src="images/Dr A.png" alt="avatar" class="w-12 h-12 rounded-full ring-2 ring-[var(--mk-accent)] object-cover"/>
          <div>
            <div id="therapistName" class="font-semibold">Dr. Ayesha Rahman</div>
            <div class="text-xs text-gray-500">Clinical Psychologist</div>
          </div>
        </div>
      </div>

      <nav class="flex-1 px-4 py-6 space-y-2">
        <button class="w-full text-left px-3 py-2 rounded-lg bg-[var(--mk-accent)] text-[var(--mk-primary)] font-medium">Dashboard</button>
        <button id="navAppointments" class="w-full text-left px-3 py-2 rounded-lg hover:bg-[#EEF4F6]">Appointments</button>
        <button id="navSessions" class="w-full text-left px-3 py-2 rounded-lg hover:bg-[#EEF4F6]">Session History</button>
        <button id="navChat" class="w-full text-left px-3 py-2 rounded-lg hover:bg-[#EEF4F6]">Chat with Clients</button>
        <button id="navSettings" class="w-full text-left px-3 py-2 rounded-lg hover:bg-[#EEF4F6]">Settings</button>
      </nav>

      <div class="p-4 border-t border-[var(--mk-accent)]">
        <button id="logoutBtn" class="w-full text-left px-3 py-2 rounded-lg text-red-600 hover:bg-[#fff2f2]">Logout</button>
      </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-6 overflow-auto">

      <!-- Top row: availability, metrics -->
      <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl font-bold">Good morning, Dr. Ayesha</h1>
          <p class="text-sm text-gray-600 mt-1">Overview of your day and recent activity</p>
        </div>

        <div class="flex items-center gap-4">
          <div class="flex items-center gap-3 bg-white border border-[var(--mk-accent)] p-3 rounded-lg">
            <label class="text-sm mr-2">Availability</label>
            <button id="availabilityToggle" class="px-3 py-1 rounded-lg bg-[var(--mk-accent)] text-[var(--mk-primary)]">Set Online</button>
          </div>

          <div class="bg-white border border-[var(--mk-accent)] p-3 rounded-lg text-center">
            <div class="text-sm text-gray-500">Upcoming</div>
            <div id="upcomingCount" class="text-xl font-semibold">2</div>
          </div>

          <div class="bg-white border border-[var(--mk-accent)] p-3 rounded-lg text-center">
            <div class="text-sm text-gray-500">Today's Sessions</div>
            <div id="todayCount" class="text-xl font-semibold">1</div>
          </div>
        </div>
      </header>

      <!-- Grid: Appointments (left) | Chat & History (right) -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left column (appointments & quick actions) -->
        <section class="lg:col-span-1 space-y-6">
          <!-- Upcoming Appointments -->
          <div class="bg-white border border-[var(--mk-accent)] rounded-2xl p-4 shadow">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">Upcoming Appointments</h2>
              <button id="viewAllAppts" class="text-sm text-[var(--mk-primary)] hover:underline">View all</button>
            </div>

            <ul id="upcomingList" class="space-y-3">
              <!-- Items injected by JS -->
            </ul>
          </div>

          <!-- Quick Actions -->
          <div class="bg-white border border-[var(--mk-accent)] rounded-2xl p-4 shadow">
            <h3 class="font-semibold mb-3">Quick Actions</h3>
            <div class="flex flex-col gap-2">
              <button id="startNextBtn" class="w-full bg-[var(--mk-pink)] text-[var(--mk-primary)] px-3 py-2 rounded-lg">Start Next Session</button>
              <button id="addNoteBtn" class="w-full border border-[var(--mk-accent)] px-3 py-2 rounded-lg">Add Session Note</button>
              <button id="downloadAllBtn" class="w-full border border-[var(--mk-accent)] px-3 py-2 rounded-lg">Download Transcripts</button>
            </div>
          </div>
        </section>

        <!-- Middle column (session history list) -->
        <section class="lg:col-span-1 space-y-6">
          <div class="bg-white border border-[var(--mk-accent)] rounded-2xl p-4 shadow">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">Session History</h2>
              <input id="sessionSearch" type="search" placeholder="Search sessions..." class="px-3 py-1 border rounded-lg" />
            </div>

            <div id="sessionHistory" class="space-y-3 max-h-72 overflow-auto scrollbar-thin">
              <!-- session entries injected -->
            </div>
          </div>

          <!-- Session notes preview -->
          <div class="bg-white border border-[var(--mk-accent)] rounded-2xl p-4 shadow">
            <h3 class="font-semibold mb-2">Selected Session Notes</h3>
            <div id="notePreview" class="text-sm text-gray-700 min-h-[80px]">Select a session to view notes.</div>
            <div class="mt-3 flex gap-2">
              <button id="editNoteBtn" class="px-3 py-1 bg-[var(--mk-accent)] rounded-lg">Edit</button>
              <button id="saveNoteBtn" class="px-3 py-1 border border-[var(--mk-accent)] rounded-lg">Save</button>
            </div>
          </div>
        </section>

        <!-- Right column (chat with clients) -->
        <section class="lg:col-span-1 flex flex-col space-y-6">
          <!-- Client list -->
          <div class="bg-white border border-[var(--mk-accent)] rounded-2xl p-4 shadow">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">Clients (Chat)</h2>
              <input id="clientSearch" type="search" placeholder="Search clients..." class="px-2 py-1 border rounded-lg text-sm" />
            </div>

            <ul id="clientList" class="space-y-3 max-h-72 overflow-auto scrollbar-thin">
              <!-- client list injected -->
            </ul>
          </div>

          <!-- Chat panel -->
          <div class="bg-white border border-[var(--mk-accent)] rounded-2xl p-3 shadow flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <div>
                <div id="chatClientName" class="font-semibold">Select a client</div>
                <div id="chatClientMeta" class="text-xs text-gray-500">No active chat</div>
              </div>
              <div>
                <button id="endChatBtn" class="px-3 py-1 rounded-lg bg-[var(--mk-pink)] text-[var(--mk-primary)]">End Chat</button>
              </div>
            </div>

            <div id="chatWindow" class="flex-1 overflow-auto p-2 bg-[#FAFCFD] rounded-lg min-h-[160px] max-h-[280px] space-y-3">
              <div class="text-sm text-gray-500">No messages yet.</div>
            </div>

            <div class="mt-3 flex gap-2">
              <input id="chatMsgInput" type="text" placeholder="Write message..." class="flex-1 px-3 py-2 border rounded-lg" />
              <button id="sendChatBtn" class="px-4 py-2 rounded-lg bg-[var(--mk-primary)] text-white">Send</button>
            </div>
          </div>
        </section>
      </div>

    </main>
  </div>

  <!-- Demo JS: front-end logic and demo data -->
  <script>
    // ---------- Demo dataset ----------
    const DEMO_APPOINTMENTS = [
      { id: 'a1', client: 'Rafiq', time: '2025-08-03T14:00:00', mode:'Video', status:'upcoming' },
      { id: 'a2', client: 'Anika', time: '2025-08-03T16:00:00', mode:'In-person', status:'upcoming' },
      { id: 'a3', client: 'Tariq', time: '2025-07-22T11:00:00', mode:'Video', status:'past', notes: 'Discussed sleep hygiene.' }
    ];

    const DEMO_CLIENTS = [
      { id:'c1', name:'Rafiq', lastMsg:'Thanks, I feel better today.', avatar:'images/client1.png' },
      { id:'c2', name:'Anika', lastMsg:'Can we move appointment?', avatar:'images/client2.png' },
      { id:'c3', name:'Tariq', lastMsg:'Thank you for today.', avatar:'images/client3.png' }
    ];

    // conversation storage key prefix
    const CONV_PREFIX = 'mk_t_conversation_'; // mk_t_conversation_<clientId>

    // ---------- Helpers ----------
    function timeLabel(iso) {
      const d = new Date(iso);
      return d.toLocaleString(undefined, { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    function getConversation(clientId) {
      try {
        const raw = localStorage.getItem(CONV_PREFIX + clientId);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function saveConversation(clientId, conv) {
      try { localStorage.setItem(CONV_PREFIX + clientId, JSON.stringify(conv)); } catch {}
    }

    // ---------- Renderers ----------
    const upcomingListEl = document.getElementById('upcomingList');
    const upcomingCountEl = document.getElementById('upcomingCount');
    const todayCountEl = document.getElementById('todayCount');
    const sessionHistoryEl = document.getElementById('sessionHistory');
    const clientListEl = document.getElementById('clientList');
    const chatWindowEl = document.getElementById('chatWindow');
    const chatClientNameEl = document.getElementById('chatClientName');
    const chatClientMetaEl = document.getElementById('chatClientMeta');
    const chatMsgInput = document.getElementById('chatMsgInput');

    function renderUpcoming() {
      upcomingListEl.innerHTML = '';
      const upcoming = DEMO_APPOINTMENTS.filter(a => a.status === 'upcoming').sort((a,b)=>new Date(a.time)-new Date(b.time));
      upcoming.forEach(a=>{
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-[#FBFDFF] border border-[#E8F0F4] p-3 rounded-lg';
        li.innerHTML = `
          <div>
            <div class="font-medium">${a.client}</div>
            <div class="text-xs text-gray-500">${timeLabel(a.time)} • ${a.mode}</div>
          </div>
          <div class="flex flex-col items-end gap-2">
            <div>
              <button class="px-3 py-1 bg-[var(--mk-accent)] rounded-lg text-[var(--mk-primary)] start-btn" data-id="${a.id}">Start</button>
            </div>
            <div>
              <button class="text-sm text-gray-500 view-details" data-id="${a.id}">Details</button>
            </div>
          </div>`;
        upcomingListEl.appendChild(li);
      });
      upcomingCountEl.textContent = upcoming.length;
      const todayCount = DEMO_APPOINTMENTS.filter(a => {
        const d = new Date(a.time);
        const now = new Date();
        return d.toDateString() === now.toDateString();
      }).length;
      todayCountEl.textContent = todayCount;
    }

    function renderSessionHistory() {
      sessionHistoryEl.innerHTML = '';
      const past = DEMO_APPOINTMENTS.filter(a => a.status === 'past').sort((a,b)=>new Date(b.time)-new Date(a.time));
      if (past.length === 0) sessionHistoryEl.innerHTML = '<div class="text-sm text-gray-500">No past sessions.</div>';
      past.forEach(s=>{
        const div = document.createElement('div');
        div.className = 'p-3 border border-[#E8F0F4] rounded-lg bg-[#FBFDFF]';
        div.innerHTML = `<div class="flex items-center justify-between">
          <div>
            <div class="font-medium">${s.client}</div>
            <div class="text-xs text-gray-500">${timeLabel(s.time)}</div>
          </div>
          <div class="text-sm text-gray-600">
            <button class="view-notes" data-id="${s.id}">Notes</button>
          </div>
        </div>`;
        sessionHistoryEl.appendChild(div);
      });
    }

    function renderClients() {
      clientListEl.innerHTML = '';
      DEMO_CLIENTS.forEach(c=>{
        const li = document.createElement('li');
        li.className = 'flex items-center gap-3 p-2 hover:bg-[#FAFAFB] rounded-lg cursor-pointer';
        li.innerHTML = `<img src="${c.avatar}" class="w-10 h-10 rounded-full object-cover" />
          <div class="flex-1">
            <div class="font-medium">${c.name}</div>
            <div class="text-xs text-gray-500">${c.lastMsg}</div>
          </div>
          <div>
            <button class="px-2 py-1 text-sm border border-[var(--mk-accent)] rounded-lg open-chat" data-id="${c.id}" data-name="${c.name}">Open</button>
          </div>`;
        clientListEl.appendChild(li);
      });
    }

    // ---------- Chat actions ----------
    let activeClientId = null;

    function openChat(clientId, clientName) {
      activeClientId = clientId;
      chatClientNameEl.textContent = clientName;
      chatClientMetaEl.textContent = `Chat with ${clientName}`;
      renderChatWindow();
    }

    function renderChatWindow() {
      chatWindowEl.innerHTML = '';
      if (!activeClientId) return;
      const conv = getConversation(activeClientId);
      if (!conv || conv.length === 0) {
        chatWindowEl.innerHTML = '<div class="text-sm text-gray-500">No messages. Send the first message.</div>';
        return;
      }
      conv.forEach(m=>{
        const div = document.createElement('div');
        if (m.from === 'client') {
          div.className = 'self-start bg-[#F1F7F7] px-3 py-2 rounded-lg max-w-[85%]';
        } else {
          div.className = 'self-end bg-[var(--mk-accent)] text-[var(--mk-primary)] px-3 py-2 rounded-lg max-w-[85%] ml-auto';
        }
        div.innerHTML = `<div>${m.text}</div><div class="text-[11px] text-gray-400 mt-1">${new Date(m.time).toLocaleString()}</div>`;
        chatWindowEl.appendChild(div);
      });
      chatWindowEl.scrollTop = chatWindowEl.scrollHeight;
    }

    function sendChatMessage() {
      const text = chatMsgInput.value.trim();
      if (!text || !activeClientId) return;
      const conv = getConversation(activeClientId);
      const msg = { id: Date.now(), from: 'therapist', text, time: new Date().toISOString() };
      conv.push(msg);
      saveConversation(activeClientId, conv);
      chatMsgInput.value = '';
      renderChatWindow();
      // Simulate client reply after delay (demo). Replace with real API or socket.
      setTimeout(()=> {
        const rconv = getConversation(activeClientId);
        rconv.push({ id: Date.now()+1, from:'client', text: 'Thank you, I will try that.', time: new Date().toISOString() });
        saveConversation(activeClientId, rconv);
        renderChatWindow();
      }, 1000);
    }

    // utility to re-render session list when needed
    function renderSessionList() { renderSessionHistory(); renderUpcoming(); renderClients(); }

    // ---------- Handlers / wiring ----------
    document.addEventListener('DOMContentLoaded', () => {
      renderUpcoming();
      renderSessionHistory();
      renderClients();
      renderSessionList(); // ensure session list UI updated

      // client open handlers
      document.querySelectorAll('.open-chat').forEach(b => {
        b.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          const name = e.currentTarget.dataset.name;
          openChat(id, name);
        });
      });

      // delegate open chat from client list (dynamic elements)
      clientListEl.addEventListener('click', (e) => {
        const btn = e.target.closest('.open-chat');
        if (btn) {
          openChat(btn.dataset.id, btn.dataset.name);
        }
      });

      // start buttons
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.start-btn');
        if (btn) {
          const apptId = btn.dataset.id;
          alert('Starting session: ' + apptId + ' (connect to interview window or video call here)');
        }
        const view = e.target.closest('.view-details');
        if (view) {
          alert('Show appointment details for ' + view.dataset.id);
        }
        if (e.target.id === 'startNextBtn') {
          const up = DEMO_APPOINTMENTS.find(a => a.status==='upcoming');
          if (up) alert('Start next session with ' + up.client);
          else alert('No upcoming session');
        }
      });

      // send chat button
      document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
      document.getElementById('chatMsgInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); sendChatMessage(); }
      });

      // quick actions
      document.getElementById('addNoteBtn').addEventListener('click', ()=> {
        const note = prompt('Write a quick note for the selected appointment:');
        if (note) alert('Note saved (demo). Integrate with backend to persist.');
      });
      document.getElementById('downloadAllBtn').addEventListener('click', ()=> {
        alert('Download transcripts (demo) — implement server-side export for real data.');
      });

      // navigation buttons (switch views - basic)
      document.getElementById('navAppointments').addEventListener('click', ()=> { window.scrollTo({ top:0, behavior:'smooth'}); });
      document.getElementById('navSessions').addEventListener('click', ()=> { window.scrollTo({ top: document.body.scrollHeight/3, behavior:'smooth'}); });
      document.getElementById('navChat').addEventListener('click', ()=> { window.scrollTo({ top: document.body.scrollHeight/1.2, behavior:'smooth'}); });

      // client list is rendered - attach open handlers dynamically
      clientListEl.querySelectorAll('.open-chat').forEach(btn => {
        btn.addEventListener('click', (e) => openChat(btn.dataset.id, btn.dataset.name));
    // (moved above to avoid ReferenceError)

    // utility to re-render session list when needed
    function renderSessionList() { renderSessionHistory(); renderUpcoming(); renderClients(); }

    // Availability toggle
    document.getElementById('availabilityToggle').addEventListener('click', function(){
      const btn = this;
      if (btn.textContent.includes('Online')) {
        btn.textContent = 'Set Offline'; btn.classList.remove('bg-[var(--mk-accent)]'); btn.classList.add('bg-white'); btn.classList.add('border'); btn.classList.add('border-[var(--mk-accent)]');
      } else {
        btn.textContent = 'Set Online'; btn.classList.add('bg-[var(--mk-accent)]'); btn.classList.remove('bg-white');
      }
    });

    // Simple search for sessions and clients (client-side)
    document.getElementById('sessionSearch').addEventListener('input', function(e){
      const q = e.target.value.toLowerCase();
      const items = DEMO_APPOINTMENTS.filter(a => (a.client.toLowerCase().includes(q) || (a.notes || '').toLowerCase().includes(q)));
      // render filtered
      sessionHistoryEl.innerHTML = '';
      items.forEach(s=>{
        const div = document.createElement('div');
        div.className = 'p-3 border border-[#E8F0F4] rounded-lg bg-[#FBFDFF]';
        div.innerHTML = `<div class="flex items-center justify-between">
          <div>
            <div class="font-medium">${s.client}</div>
            <div class="text-xs text-gray-500">${timeLabel(s.time)}</div>
          </div>
          <div class="text-sm text-gray-600">
            <button class="view-notes" data-id="${s.id}">Notes</button>
          </div>
        </div>`;
        sessionHistoryEl.appendChild(div);
      });
    });

    // simple client search
    document.getElementById('clientSearch').addEventListener('input', function(e){
      const q = e.target.value.toLowerCase();
      clientListEl.innerHTML = '';
      DEMO_CLIENTS.filter(c => c.name.toLowerCase().includes(q) || c.lastMsg.toLowerCase().includes(q)).forEach(c=>{
        const li = document.createElement('li');
        li.className = 'flex items-center gap-3 p-2 hover:bg-[#FAFAFB] rounded-lg cursor-pointer';
        li.innerHTML = `<img src="${c.avatar}" class="w-10 h-10 rounded-full object-cover" />
          <div class="flex-1">
            <div class="font-medium">${c.name}</div>
            <div class="text-xs text-gray-500">${c.lastMsg}</div>
          </div>
          <div><button class="px-2 py-1 text-sm border border-[var(--mk-accent)] rounded-lg open-chat" data-id="${c.id}" data-name="${c.name}">Open</button></div>`;
        clientListEl.appendChild(li);
      });
    });

  </script>
</body>
</html>
